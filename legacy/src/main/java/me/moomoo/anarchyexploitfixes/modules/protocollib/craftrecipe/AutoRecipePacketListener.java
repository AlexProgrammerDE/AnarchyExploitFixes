package me.moomoo.anarchyexploitfixes.modules.protocollib.craftrecipe;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import me.moomoo.anarchyexploitfixes.utils.models.ExpiringSet;

import java.time.Duration;
import java.util.UUID;

public class AutoRecipePacketListener extends PacketAdapter {

    private final ExpiringSet<UUID> recipeCooldowns;

    protected AutoRecipePacketListener(AnarchyExploitFixes plugin, long craftingRecipeDelayInMillis) {
        super(plugin, ListenerPriority.HIGHEST, PacketType.Play.Client.AUTO_RECIPE);
        this.recipeCooldowns = new ExpiringSet<>(Duration.ofMillis(craftingRecipeDelayInMillis));
    }

    protected void register() {
        ProtocolLibrary.getProtocolManager().addPacketListener(this);
    }

    @Override
    public void onPacketReceiving(PacketEvent event) {
        if (event.isPlayerTemporary() || event.getPlayer() == null) return;

        final UUID playerUniqueID = event.getPlayer().getUniqueId();

        if (recipeCooldowns.contains(playerUniqueID)) {
            event.setCancelled(true);
        } else {
            recipeCooldowns.add(playerUniqueID);
        }
    }
}