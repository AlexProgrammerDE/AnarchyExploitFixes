plugins {
    id("aef.project-conventions")
    id("com.github.johnrengelman.shadow")
    id("xyz.jpenilla.run-paper")
}

runPaper.folia.registerTask()

tasks {
    runServer {
        minecraftVersion("1.20.4")
    }
}

dependencies {
    api(projects.common)
    api(projects.folia)

    compileOnly("com.destroystokyo.paper:paper-api:1.12.2-R0.1-SNAPSHOT")

    api("com.github.thatsmusic99:ConfigurationMaster-API:v2.0.0-rc.1") // ConfigurationMaster for enhanced config management
    api("cloud.commandframework:cloud-paper:1.8.4") // Command Framework
    api("cloud.commandframework:cloud-annotations:1.8.4")
    compileOnly("com.comphenix.protocol:ProtocolLib:5.1.0") // ProtocolLib to patch packet based exploits
    api("de.tr7zw:item-nbt-api:2.12.2") // NBT API for cross version nbt tag handling
    api("io.papermc:paperlib:1.0.8") // Useful Paper related tools
    api("org.bstats:bstats-bukkit:3.0.2") // Bukkit bStats
    api("org.apache.commons:commons-math3:3.6.1") // FastMath
    api("com.ibm.icu:icu4j:74.2") // Rule based number format used in first join messages to format to ordinal based on locale
    api("com.github.ben-manes.caffeine:caffeine:3.1.8") // Fast caching
    api("com.github.cryptomorin:XSeries:9.8.0") // XSeries for cross-version support

    api("net.kyori:adventure-platform-bukkit:4.3.1")
    api("net.kyori:adventure-text-minimessage:4.14.0")
}

tasks.jar {
    archiveFileName = "${rootProject.name}-${project.version}-unshaded.jar"
}

tasks.build.configure {
    dependsOn("shadowJar")
}

tasks.shadowJar {
    archiveFileName = "${rootProject.name}-${project.version}.jar"
    exclude(
        "LICENSE",
        "META-INF/maven/**",
        "META-INF/**/module-info.class",
        "META-INF/MANIFEST.MF",
        "META-INF/LICENSE",
        "META-INF/LICENSE.txt",
        "META-INF/NOTICE.txt",
        "com/cryptomorin/xseries/XBiome*",
        "com/cryptomorin/xseries/XEntity*",
        "com/cryptomorin/xseries/XPotion*",
        "com/cryptomorin/xseries/NMSExtras*",
        "com/cryptomorin/xseries/NoteBlockMusic*",
        "com/cryptomorin/xseries/SkullCacheListener*"
    )
    relocate("com.github.benmanes.caffeine", "me.moomoo.anarchyexploitfixes.libs.caffeine")
    relocate("io.papermc.lib", "me.moomoo.anarchyexploitfixes.libs.paperlib")
    relocate("de.tr7zw.changeme.nbtapi", "me.moomoo.anarchyexploitfixes.libs.nbtapi")
    relocate("org.bstats", "me.moomoo.anarchyexploitfixes.libs.bstats")
}
