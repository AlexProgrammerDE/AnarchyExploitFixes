package me.moomoo.anarchyexploitfixes.commands;

import cloud.commandframework.annotations.Argument;
import cloud.commandframework.annotations.CommandDescription;
import cloud.commandframework.annotations.CommandMethod;
import cloud.commandframework.annotations.CommandPermission;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import me.moomoo.anarchyexploitfixes.common.AEFModule;
import me.moomoo.anarchyexploitfixes.modules.AEFModules;
import me.moomoo.anarchyexploitfixes.utils.KyoriUtil;
import net.kyori.adventure.text.Component;
import net.kyori.adventure.text.event.ClickEvent;
import net.kyori.adventure.text.format.NamedTextColor;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.plugin.PluginDescriptionFile;

import java.util.Arrays;
import java.util.Objects;

public class AEFCommand implements AnarchyExploitFixesCommand {

    private final AnarchyExploitFixes plugin;

    public AEFCommand() {
        this.plugin = AnarchyExploitFixes.getInstance();
    }

    @Override
    public boolean shouldRegister() {
        return true;
    }

    @CommandMethod("aef version")
    @CommandDescription("Get the plugin version.")
    @CommandPermission("anarchyexploitfixes.cmd.version")
    public void versionCommand(
            final CommandSender sender
    ) {
        PluginDescriptionFile pluginMeta = plugin.getDescription();
        KyoriUtil.sendMessage(sender,
                Component.newline()
                        .append(Component.text(pluginMeta.getName() + " " + pluginMeta.getVersion()).color(NamedTextColor.GOLD)
                                .append(Component.text(" by ").color(NamedTextColor.GRAY))
                                .append(Component.text(pluginMeta.getAuthors().get(0) + " & " + pluginMeta.getAuthors().get(1)).color(NamedTextColor.DARK_AQUA))
                                .clickEvent(ClickEvent.openUrl(pluginMeta.getWebsite())))
                        .append(Component.newline())
        );
    }

    @CommandMethod("aef disable")
    @CommandDescription("Disable all plugin features.")
    @CommandPermission("anarchyexploitfixes.cmd.disable")
    public void disableCommand(
            final CommandSender sender
    ) {
        KyoriUtil.sendMessage(sender, Component.text("Disabling plugin.").color(NamedTextColor.RED));
        AEFModules.modules.forEach(AEFModule::disable);
        AEFModules.unregisterPacketListeners(plugin);
        KyoriUtil.sendMessage(sender, Component.text("All enabled plugin features have been disabled.").color(NamedTextColor.GREEN));
        KyoriUtil.sendMessage(sender, Component.text("Use /aef reload to enable the plugin again. " +
                "You can also use third party options like plugman or serverutils.").color(NamedTextColor.WHITE));
    }

    @CommandMethod("aef reload")
    @CommandDescription("Reload the plugin configuration.")
    @CommandPermission("anarchyexploitfixes.cmd.reload")
    public void reloadCommand(
            final CommandSender sender
    ) {
        KyoriUtil.sendMessage(sender, Component.text("Reloading AnarchyExploitFixes...").color(NamedTextColor.WHITE));
        plugin.reloadPlugin();
        KyoriUtil.sendMessage(sender, Component.text("Reload complete.").color(NamedTextColor.GREEN));
    }

    @CommandMethod("aef lag <milliseconds>")
    @CommandDescription("Artificially lag the server for testing.")
    @CommandPermission("anarchyexploitfixes.cmd.lag")
    public void lagCommand(
            final CommandSender sender,
            final @Argument(value = "milliseconds", description = "Lag duration in milliseconds") long millis
    ) {
        try {
            Thread.sleep(millis);
        } catch (InterruptedException e) {
            KyoriUtil.sendMessage(sender, Component.text("Operation was interrupted! - " + e.getLocalizedMessage()).color(NamedTextColor.RED));
            e.printStackTrace();
        }
    }

    @CommandMethod("aef elytra")
    @CommandDescription("Show how many players are currently flying with an elytra.")
    @CommandPermission("anarchyexploitfixes.cmd.elytra")
    public void elytraCommand(
            final CommandSender sender
    ) {
        StringBuilder flying = new StringBuilder();
        StringBuilder notFlying = new StringBuilder();
        int glidingPlayerCount = 0;
        int nonGlidingPlayerCount = 0;

        for (Player player : plugin.getServer().getOnlinePlayers()) {
            if (player.isGliding()) {
                flying.append(player.getName()).append(", ");
                glidingPlayerCount++;
            } else {
                notFlying.append(player.getName()).append(", ");
                nonGlidingPlayerCount++;
            }
        }

        KyoriUtil.sendMessage(sender, Component.newline());
        KyoriUtil.sendMessage(sender,
                Component.text("Elytra flying: ").color(NamedTextColor.WHITE)
                        .append(Component.text(flying.toString()).color(NamedTextColor.GOLD))
                        .append(Component.text(" (" + glidingPlayerCount + ")").color(NamedTextColor.WHITE))
        );
        KyoriUtil.sendMessage(sender,
                Component.text("Not elytra flying: ").color(NamedTextColor.WHITE)
                        .append(Component.text(notFlying.toString()).color(NamedTextColor.GOLD))
                        .append(Component.text(" (" + nonGlidingPlayerCount + ")").color(NamedTextColor.WHITE))
        );
        KyoriUtil.sendMessage(sender,
                Component.text("Total players: ").color(NamedTextColor.WHITE)
                        .append(Component.text(String.valueOf(glidingPlayerCount + nonGlidingPlayerCount)).color(NamedTextColor.GOLD))
        );
        KyoriUtil.sendMessage(sender, Component.newline());
    }

    @CommandMethod("aef geared")
    @CommandDescription("Show how many players are currently wearing at least one armor piece.")
    @CommandPermission("anarchyexploitfixes.cmd.geared")
    public void gearedCommand(
            final CommandSender sender
    ) {
        StringBuilder geared = new StringBuilder();
        StringBuilder ungeared = new StringBuilder();
        int gearedPlayerCount = 0;
        int ungearedPlayerCount = 0;

        for (Player player : plugin.getServer().getOnlinePlayers()) {
            if (Arrays.stream(player.getInventory().getArmorContents()).noneMatch(Objects::isNull)) {
                geared.append(player.getName()).append(", ");
                gearedPlayerCount++;
            } else {
                ungeared.append(player.getName()).append(", ");
                ungearedPlayerCount++;
            }
        }

        KyoriUtil.sendMessage(sender, Component.newline());
        KyoriUtil.sendMessage(sender,
                Component.text("Geared players: ").color(NamedTextColor.WHITE)
                        .append(Component.text(geared.toString()).color(NamedTextColor.GOLD))
                        .append(Component.text(" (" + gearedPlayerCount + ")").color(NamedTextColor.WHITE))
        );
        KyoriUtil.sendMessage(sender,
                Component.text("Ungeared players: ").color(NamedTextColor.WHITE)
                        .append(Component.text(ungeared.toString()).color(NamedTextColor.GOLD))
                        .append(Component.text(" (" + ungearedPlayerCount + ")").color(NamedTextColor.WHITE))
        );
        KyoriUtil.sendMessage(sender,
                Component.text("Total players: ").color(NamedTextColor.WHITE)
                        .append(Component.text(String.valueOf(ungearedPlayerCount + gearedPlayerCount)).color(NamedTextColor.GOLD))
        );
        KyoriUtil.sendMessage(sender, Component.newline());
    }
}
